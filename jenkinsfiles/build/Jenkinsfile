node{

  git branch: "test", url: "https://github.com/robsonbittencourt/jenkins-pipeline-example" 

//   stage('Test') {
//     parallel 'unit': {
//         stage('Unit Tests') {
//             withEnv(["JAVA_HOME=${ tool "java-8" }", "PATH+MAVEN=${ tool "maven" }/bin:${env.JAVA_HOME}/bin"]) {
//                 sh "mvn test"
//             }
//         }
//     }, 'integration': {
//         stage('Integration Tests') {
//             withEnv(["JAVA_HOME=${ tool "java-8" }", "PATH+MAVEN=${ tool "maven" }/bin:${env.JAVA_HOME}/bin"]) {
//                 sh "mvn verify -Pit-tests"
//             }
//         }
//     }  
//   }

//   stage ('Sonar') {
//     withEnv(["JAVA_HOME=${ tool "java-8" }", "PATH+MAVEN=${ tool "maven" }/bin:${env.JAVA_HOME}/bin"]) {
//         sh "mvn sonar:sonar -Dsonar.host.url=http://sonar:9000"
//     }
//   }
  
//   stage ('Ui Tests') {
//     withEnv(["JAVA_HOME=${ tool "java-8" }", "PATH+MAVEN=${ tool "maven" }/bin:${env.JAVA_HOME}/bin"]) {
//         sh "mvn verify -Pui-tests"
//     }
//   }

  stage ('Build Jar') {
    withEnv(["JAVA_HOME=${ tool "java-8" }", "PATH+MAVEN=${ tool "maven" }/bin:${env.JAVA_HOME}/bin"]) {
        sh "mvn package -Dmaven.test.skip=true"
    }
  }

  stage ('Build Image') {
    withEnv(["JAVA_HOME=${ tool "java-8" }", "PATH+MAVEN=${ tool "maven" }/bin:${env.JAVA_HOME}/bin"]) {
        VERSION = sh "printf 'VER\t\${project.version}' | mvn help:evaluate | grep '^VER' | cut -f2"

        sh "echo ${VERSION}"
        
        sh "docker build --build-arg version=${VERSION} \
            -t robsonbittencourt/jenkins-pipeline-example:dsv-latest \
            -t robsonbittencourt/jenkins-pipeline-example:dsv-${VERSION} . ;"
    }
  }

  stage ('Deploy image') {
    withEnv(["JAVA_HOME=${ tool "java-8" }", "PATH+MAVEN=${ tool "maven" }/bin:${env.JAVA_HOME}/bin"]) {
        VERSION = sh "printf 'VER\t${project.version}' | mvn help:evaluate | grep '^VER' | cut -f2"
        
        sh "docker push docker.io/robsonbittencourt/jenkins-pipeline-example:dsv-latest ;"
        sh "docker push docker.io/robsonbittencourt/jenkins-pipeline-example:dsv-${VERSION} ;"
    }
  }
  
//   stage ('Deploy container') {
//     withEnv(["JAVA_HOME=${ tool "java-8" }", "PATH+MAVEN=${ tool "maven" }/bin:${env.JAVA_HOME}/bin"]) {
//         sh "docker restart app-dsv"
//     }
//   }
}